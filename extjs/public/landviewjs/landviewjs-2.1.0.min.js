!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.LandViewJS=e.LandViewJS||{})}(this,function(e){"use strict";function t(e,t){this._latitude=0,this._longitude=0,this.setLatitude(e||0),this.setLongitude(t||0)}function i(e,t){this.x=e||0,this.y=t||0}function o(e,t,i){this._phi=0,this._theta=0,this._radius=i||0,this.setPhi(e||0),this.setTheta(t||0)}function n(){}function r(e,i,o){this._panoId=e||"",this._angle=o||0,this._position=0,this._positionXY=0,this.setPosition(i||new t)}function a(e,t,i){this._panoId=e||"",this._heading=t||0,this._distanceMeters=i||0}function s(e,t,i,o){this._row=0,this._pitch=0,this._heading=0,this._fov=0,this.setRow(e||0),this.setPitch(t||0),this.setHeading(i||0),this.setFieldOfView(o||s.MaxFieldOfView)}function h(e){this.cameraPov=e||new s}function d(e,t,i,o){this._id=e,this._onLinkClickedFunction=i,this._povChangedFunction=o,this._initialized=!1,this._userInteracting=!1,this._row=0,this._phi=0,this._theta=0,this._tileServerUrl=t,this._photo=void 0,this._photoLinks=[],this._pinch=!1,this._pinchDistance=0,this._pov=new s,this._oldX=0,this._oldY=0,this._oldPov=new s,this._container=void 0,this._camera=void 0,this._scene=void 0,this._renderer=void 0,this._textureLoader=new THREE.TextureLoader,this._textureLoader.crossOrigin="",this._raycaster=new THREE.Raycaster,this._mouse=new THREE.Vector2,this._target=new THREE.Vector3,this._scaleMatrix=new THREE.Matrix4,this._scaleMatrix.makeScale(-1,1,1),this._currentZoomLevel=3,this._openedTiles={},this._viewCoords=[new THREE.Vector2(-1,-1),new THREE.Vector2(-1,1),new THREE.Vector2(1,1),new THREE.Vector2(1,-1),new THREE.Vector2(0,1),new THREE.Vector2(0,-1),new THREE.Vector2(-.5,-.5),new THREE.Vector2(-.5,.5),new THREE.Vector2(.5,.5),new THREE.Vector2(.5,-.5),new THREE.Vector2(0,.5),new THREE.Vector2(0,-.5)],this._sphereRadiusByZoomLevel=[_+3,_+2,_+1,_],this._povChangedArgs=new h,this._oldPovChangedArgs=new h}function p(e,t,i,o,n){var r=this;this._panoViewer=new d(e,t,function(e,t){r._onLinkClicked(e,t)},o),this._panoViewer.initialize(),this._panoProvider=i,this._currentPanoId="",this._isSearchingPanorama=!1,this._onPanoLinkLoadedFunction=n}function u(e){this._options=e||{},this._url=this._options.url,this._searchRadiusMeters=void 0!==this._options.searchRadiusMeters?this._options.searchRadiusMeters:50,this._addDirtyWhere=void 0===this._options.addDirtyWhere||this._options.addDirtyWhere,0!==this._url.length&&"/"!==this._url.slice(-1)&&(this._url+="/"),this._searchRadiusMeters<20?this._searchRadiusMeters=20:this._searchRadiusMeters>1e3&&(this._searchRadiusMeters=1e3)}function c(e){this._options=e||{},this._url=this._options.url,this._typeName=this._options.typeName,this._serverType=void 0!==this._options.serverType?this._options.serverType:"GEOSERVER",this._geojsonOutputFormat=void 0!==this._options.geojsonOutputFormat?this._options.geojsonOutputFormat:"application/json",this._useJSONP=void 0!==this._options.useJSONP&&this._options.useJSONP,this._searchRadiusMeters=void 0!==this._options.searchRadiusMeters?this._options.searchRadiusMeters:50,this._searchRadiusMeters<20?this._searchRadiusMeters=20:this._searchRadiusMeters>1e3&&(this._searchRadiusMeters=1e3),-1!==this._url.indexOf("?")?this._url=this._url+"&":this._url=this._url+"?"}var _=20;t.prototype.constructor=t,t.prototype.getLatitude=function(){return this._latitude},t.prototype.setLatitude=function(e){this._latitude=Math.max(-90,Math.min(90,e))},t.prototype.getLongitude=function(){return this._longitude},t.prototype.setLongitude=function(e){this._longitude=Math.max(-180,Math.min(180,e))},t.prototype.toString=function(e){return void 0===e&&(e=6),this._longitude.toFixed(e)+","+this._latitude.toFixed(e)},i.prototype.constructor=i,i.prototype.toString=function(e){return void 0===e&&(e=6),this.x.toFixed(e)+","+this.y.toFixed(e)},i.distance=function(e,t){var i=e.x-t.x,o=e.y-t.y;return Math.sqrt(i*i+o*o)},i.distanceSquared=function(e,t){var i=e.x-t.x,o=e.y-t.y;return i*i+o*o},i.angle=function(e,t){var i=t.x-e.x,o=t.y-e.y,n=Math.atan2(o,i);return n<0&&(n+=2*Math.PI),n},o.prototype.constructor=o,o.prototype.getPhi=function(){return this._phi},o.prototype.setPhi=function(e){this._phi=Math.max(-90,Math.min(90,e))},o.prototype.getTheta=function(){return this._theta},o.prototype.setTheta=function(e){this._theta=Math.max(-180,Math.min(180,e))},o.prototype.getRadius=function(){return this._radius},o.prototype.setRadius=function(e){this._radius=e},n.R=6378137,n.prototype.constructor=n,n.geographicToWebMercator=function(e){var t=e.getLatitude()*Math.PI/180,o=e.getLongitude()*Math.PI/180,r=new i;return r.x=o*n.R,r.y=Math.log(Math.tan(Math.PI/4+t/2))*n.R,r},n.webMercatorToGeographic=function(e){var i=new t;return i.setLongitude(e.x/n.R*(180/Math.PI)),i.setLatitude((2*Math.atan(Math.exp(e.y/n.R))-Math.PI/2)*(180/Math.PI)),i},r.prototype.constructor=r,r.prototype.getPanoId=function(){return this._panoId},r.prototype.setPanoId=function(e){this._panoId=e},r.prototype.getPosition=function(){return this._position},r.prototype.setPosition=function(e){this._position=e,this._positionXY=n.geographicToWebMercator(this._position)},r.prototype.getAngle=function(){return this._angle},r.prototype.setAngle=function(e){this._angle=e},r.prototype.getDateOfPictureTaken=function(){var e,t,i;return""!==this._panoId?(e=parseInt(this._panoId.substring(2,6)),t=parseInt(this._panoId.substring(7,9)),i=parseInt(this._panoId.substring(9,11)),new Date(e,t,i)):new Date},r.prototype.headingTo=function(e){var t=n.geographicToWebMercator(e),o=i.angle(this._positionXY,t);o*=180/Math.PI;var r=0;return this._angle>o?(r=this._angle-o)>180&&(r=-(r=360-r)):r=(r=o-this._angle)>180?360-r:-r,r},a.prototype.constructor=a,a.prototype.getPanoId=function(){return this._panoId},a.prototype.setPanoId=function(e){this._panoId=e},a.prototype.getHeading=function(){return this._heading},a.prototype.setHeading=function(e){this._heading=e},a.prototype.getDistanceMeters=function(){return this._distanceMeters},a.prototype.setDistanceMeters=function(e){this._distanceMeters=e},s.MinRow=-180,s.MaxRow=180,s.MinPitch=-85,s.MaxPitch=85,s.MinHeading=-180,s.MaxHeading=180,s.MinFieldOfView=11.25,s.MaxFieldOfView=90,s.prototype.constructor=s,s.prototype.setRow=function(e){this._row=Math.max(s.MinRow,Math.min(s.MaxRow,e))},s.prototype.getRow=function(){return this._row},s.prototype.getHeading=function(){return this._heading},s.prototype.setHeading=function(e){this._heading=Math.max(s.MinHeading,Math.min(s.MaxHeading,e))},s.prototype.getPitch=function(){return this._pitch},s.prototype.setPitch=function(e){this._pitch=Math.max(s.MinPitch,Math.min(s.MaxPitch,e))},s.prototype.getFieldOfView=function(){return this._fov},s.prototype.setFieldOfView=function(e){this._fov=Math.max(s.MinFieldOfView,Math.min(s.MaxFieldOfView,e))},h.prototype.constructor=h,d.prototype.constructor=d,d.prototype.getPov=function(){return this._pov},d.prototype.setPov=function(e){this._pov=e,this._initialized&&(this._camera.fov=this._pov.getFieldOfView(),this._onPovChanged(),this.update())},d.prototype.getCurrentZoomLevel=function(){return this._currentZoomLevel},d.prototype.initialize=function(){var e=this;this._initialized||(this._target.x=0,this._target.y=0,this._target.z=0,this._container=document.getElementById(this._id),this._renderer=new THREE.WebGLRenderer({antialias:!1,preserveDrawingBuffer:!1}),this._renderer.domElement.style.margin="0",this._renderer.domElement.style.padding="0",this._renderer.domElement.style.border="0",this._renderer.domElement.style.position="relative",this._renderer.domElement.style.width="100%",this._renderer.domElement.style.height="100%",this._container.appendChild(this._renderer.domElement),this._renderer.domElement.width=this._renderer.domElement.clientWidth,this._renderer.domElement.height=this._renderer.domElement.clientHeight,this._renderer.setViewport(0,0,this._renderer.domElement.clientWidth,this._renderer.domElement.clientHeight),this._renderer.setClearColor(16777215,1),this._camera=new THREE.PerspectiveCamera(this._pov.getFieldOfView(),this._renderer.domElement.clientWidth/this._renderer.domElement.clientHeight,1,1100),this._camera.lookAt(this._target),this._scene=new THREE.Scene,this._container.addEventListener("mousedown",function(t){return e._onMouseDown(t)},!1),this._container.addEventListener("mousemove",function(t){return e._onMouseMove(t)},!1),this._container.addEventListener("mouseout",function(t){return e._onMouseOut(t)},!1),this._container.addEventListener("mouseup",function(t){return e._onMouseUp(t)},!1),this._container.addEventListener("mousewheel",function(t){return e._onMouseWheel(t)},!1),this._container.addEventListener("DOMMouseScroll",function(t){return e._onMouseWheel(t)},!1),this._container.addEventListener("touchstart",function(t){return e._onTouchStart(t)},!1),this._container.addEventListener("touchmove",function(t){return e._onTouchMove(t)},!1),this._container.addEventListener("touchend",function(t){return e._onTouchEnd(t)},!1),this._container.addEventListener("dblclick",function(t){return e._onMouseDoubleClick(t)},!1),this._onResizeElement(this._renderer.domElement,function(){void 0!==e._renderer&&(e._renderer.domElement.width=e._renderer.domElement.clientWidth,e._renderer.domElement.height=e._renderer.domElement.clientHeight,e._renderer.setViewport(0,0,e._renderer.domElement.clientWidth,e._renderer.domElement.clientHeight),e._camera.aspect=e._renderer.domElement.clientWidth/e._renderer.domElement.clientHeight,e._camera.updateProjectionMatrix())}),this._initialized=!0,setInterval(function(){e._photo&&!e._userInteracting&&e._loadCurrentTiles()},1e3),this.render())},d.prototype._onResizeElement=function(e,t){var i=e.clientHeight,o=e.clientWidth;return setInterval(function(){e.clientHeight==i&&e.clientWidth==o||(i=e.clientHeight,o=e.clientWidth,t())},500)},d.prototype._onMouseDown=function(e){this._photo&&this._initialized&&(e.preventDefault(),this._userInteracting=!0,this._oldX=e.clientX,this._oldY=e.clientY,this._oldPov.setRow(this._pov.getRow()),this._oldPov.setPitch(this._pov.getPitch()),this._oldPov.setHeading(this._pov.getHeading()),this._oldPov.setFieldOfView(this._pov.getFieldOfView()))},d.prototype._onMouseMove=function(e){if(this._photo&&this._initialized&&this._userInteracting){var t=(this._camera.fov-s.MinFieldOfView)/(s.MaxFieldOfView-s.MinFieldOfView)*.1;t<.01&&(t=.01),this._pov.setPitch((e.clientY-this._oldY)*t+this._oldPov.getPitch());var i=(this._oldX-e.clientX)*t+this._oldPov.getHeading();i>s.MaxHeading?i-=s.MaxHeading-s.MinHeading:i<s.MinHeading&&(i+=s.MaxHeading-s.MinHeading),this._pov.setHeading(i),this._onPovChanged()}},d.prototype._onMouseUp=function(e){this._userInteracting=!1},d.prototype._onMouseOut=function(e){this._userInteracting=!1},d.prototype._onMouseWheel=function(e){if(this._photo&&this._camera)if(e.altKey){var t=this._pov.getRow();void 0!==e.wheelDelta?t-=.015*e.wheelDelta:void 0!==e.wheelDeltaY?t-=.015*e.wheelDeltaY:void 0!==e.detail&&(t+=e.detail),t>s.MaxHeading?t-=s.MaxRow-s.MinRow:t<s.MinRow&&(t+=s.MaxRow-s.MinRow),this._pov.setRow(t),this._onPovChanged()}else{var i=this._pov.getFieldOfView();void 0!==e.wheelDelta?i-=.05*e.wheelDelta:void 0!==e.wheelDeltaY?i-=.05*e.wheelDeltaY:void 0!==e.detail&&(i+=e.detail),this._pov.setFieldOfView(i),this._camera.fov=this._pov.getFieldOfView(),this._camera.updateProjectionMatrix(),this._onPovChanged()}},d.prototype._onTouchStart=function(e){this._photo&&this._initialized&&(2!==e.touches.length?(e.preventDefault(),this._userInteracting=!0,this._oldX=e.touches[0].pageX,this._oldY=e.touches[0].pageY,this._oldPov.setHeading(this._pov.getHeading()),this._oldPov.setPitch(this._pov.getPitch()),this._oldPov.setFieldOfView(this._pov.getFieldOfView())):2===e.touches.length&&(e.preventDefault(),this._pinchDistance=(e.touches[0].pageX-e.touches[1].pageX)*(e.touches[0].pageX-e.touches[1].pageX)+(e.touches[0].pageY-e.touches[1].pageY)*(e.touches[0].pageY-e.touches[1].pageY),this._pinch=!0))},d.prototype._onTouchMove=function(e){if(this._photo&&this._initialized&&this._userInteracting)if(this._pinch){if(2===e.touches.length){var t=(e.touches[0].pageX-e.touches[1].pageX)*(e.touches[0].pageX-e.touches[1].pageX)+(e.touches[0].pageY-e.touches[1].pageY)*(e.touches[0].pageY-e.touches[1].pageY),i=1;this._pinchDistance>0&&((i=t/this._pinchDistance)>1?i=1+.05*(i-1):i<1&&(i*=.95)),this._pov.setFieldOfView(this._camera.fov*i),this._camera.fov=this._pov.getFieldOfView(),this._camera.updateProjectionMatrix(),this._onPovChanged()}}else{(i=(this._camera.fov-s.MinFieldOfView)/(s.MaxFieldOfView-s.MinFieldOfView)*.1)<.01&&(i=.01);var o=e.touches[0].pageX,n=e.touches[0].pageY;this._pov.setPitch((n-this._oldY)*i+this._oldPov.getPitch());var r=(this._oldX-o)*i+this._oldPov.getHeading();r>s.MaxHeading?r-=s.MaxHeading-s.MinHeading:r<s.MinHeading&&(r+=s.MaxHeading-s.MinHeading),this._pov.setHeading(r),this._onPovChanged()}},d.prototype._onTouchEnd=function(e){this._userInteracting=!1,this._pinch=!1},d.prototype._onMouseDoubleClick=function(e){if(this._photo&&this._initialized&&!this._userInteracting){for(var t=this.mouseToSphere(e.offsetX,e.offsetY),i=t.getTheta(),o=t.getPhi(),n=i-15,r=i+15,a=n+360,s=r-360,h=[],d=0;d<this._photoLinks.length;++d){u=this._photoLinks[d].getHeading();n>=-180&&r<=180?u>=n&&u<=r&&h.push(this._photoLinks[d]):n<-180?(u>=-180&&u<=r||u>=a&&u<=180)&&h.push(this._photoLinks[d]):r>180&&(u>=n&&u<=180||u>=-180&&u<=s)&&h.push(this._photoLinks[d])}if(0===h.length){var p=this._pov.getFieldOfView()/2;a=(n=this._pov.getHeading()-p)+360,s=(r=this._pov.getHeading()+p)-360;for(d=0;d<this._photoLinks.length;++d){var u=this._photoLinks[d].getHeading();n>=-180&&r<=180?u>=n&&u<=r&&h.push(this._photoLinks[d]):n<-180?(u>=-180&&u<=r||u>=a&&u<=180)&&h.push(this._photoLinks[d]):r>180&&(u>=n&&u<=180||u>=-180&&u<=s)&&h.push(this._photoLinks[d])}}if(h.length>0){for(var c,_=2.5*Math.tan((90-Math.abs(o))*Math.PI/180),l=-1,g=Number.MAX_VALUE,d=1;d<h.length;++d)(c=Math.abs(_-h[d].getDistanceMeters()))<g&&(l=d,g=c);-1!==l&&this._onLinkClickedFunction(h[l],this._photo)}}},d.prototype._onPovChanged=function(){this._checkZoomLevel(),this._povChangedFunction&&(this._povChangedArgs.cameraPov.setRow(this._pov.getRow()),this._povChangedArgs.cameraPov.setPitch(this._pov.getPitch()),this._povChangedArgs.cameraPov.setHeading(this._pov.getHeading()),this._povChangedArgs.cameraPov.setFieldOfView(this._pov.getFieldOfView()),this._oldPovChangedArgs.cameraPov.getRow()===this._povChangedArgs.cameraPov.getRow()&&this._oldPovChangedArgs.cameraPov.getPitch()===this._povChangedArgs.cameraPov.getPitch()&&this._oldPovChangedArgs.cameraPov.getHeading()===this._povChangedArgs.cameraPov.getHeading()&&this._oldPovChangedArgs.cameraPov.getFieldOfView()===this._povChangedArgs.cameraPov.getFieldOfView()||(this._oldPovChangedArgs.cameraPov.setRow(this._povChangedArgs.cameraPov.getRow()),this._oldPovChangedArgs.cameraPov.setPitch(this._povChangedArgs.cameraPov.getPitch()),this._oldPovChangedArgs.cameraPov.setHeading(this._povChangedArgs.cameraPov.getHeading()),this._oldPovChangedArgs.cameraPov.setFieldOfView(this._povChangedArgs.cameraPov.getFieldOfView()),this._povChangedFunction(this._povChangedArgs)))},d.prototype.loadPanorama=function(e,t){var i=this;if(i._initialized){if(i._photo&&i._photo.getPanoId()===e.getPanoId())return;for(i._openedTiles={};i._scene.children.length>0;)i._scene.remove(i._scene.children[0]);i._photo=e,i._photoLinks=t,i._loadDefaultTiles(),i._checkZoomLevel()}},d.prototype._loadDefaultTiles=function(){var e,t,i,o,n,r,a=Math.PI,s=Math.PI;for(n=0;n<2;++n)for(t=n*s,o=0;o<1;++o){e=o*a,r=this._createTileUrl(1,n,o),i="1_"+n.toFixed(0)+"_"+o.toFixed(0);var h=new THREE.SphereGeometry(this._sphereRadiusByZoomLevel[0],30,40,t,s,e,a);h.applyMatrix(this._scaleMatrix);var d=new THREE.MeshBasicMaterial({map:this._textureLoader.load(r),transparent:!0}),p=new THREE.Mesh(h,d);this._openedTiles[i]=i,this._scene.add(p)}},d.prototype._loadCurrentTiles=function(){var e,t,i,o,n,r,a,s,h,d,p,u,c,_,l,g=Math.PI,f=0,v=2*Math.PI,m=0,P=Math.pow(2,this._currentZoomLevel-1),y=2*P,M=Math.PI/P,E=2*Math.PI/y,w=60/y,T=40/P;for(r=0;r<this._viewCoords.length;++r)for(this._raycaster.setFromCamera(this._viewCoords[r],this._camera),h=this._raycaster.intersectObjects(this._scene.children),a=0;a<h.length;++a)d=Math.atan2(h[a].point.z,h[a].point.x),p=Math.acos(h[a].point.y/h[a].distance),d<0&&(d+=2*Math.PI),g=Math.min(g,p),f=Math.max(f,p),v=Math.min(v,d),m=Math.max(m,d);for(u=Math.floor(g/M),c=Math.floor(f/M),_=Math.floor(v/E),l=Math.floor(m/E),l=Math.min(l,y-1),c=Math.min(c,P-1),n=_;n<=l;++n)for(o=u;o<=c;++o)if(i=this._currentZoomLevel.toFixed(0)+"_"+n.toFixed(0)+"_"+o.toFixed(0),!this._openedTiles.hasOwnProperty(i)){t=n*E,e=o*M,s=this._createTileUrl(this._currentZoomLevel,n,o);var R=new THREE.SphereGeometry(this._sphereRadiusByZoomLevel[this._currentZoomLevel-1],w,T,t,E,e,M);R.applyMatrix(this._scaleMatrix);var I=new THREE.MeshBasicMaterial({map:this._textureLoader.load(s),transparent:!0}),S=new THREE.Mesh(R,I);this._openedTiles[i]=i,this._scene.add(S)}},d.prototype._checkZoomLevel=function(){this._camera.fov>45?this._currentZoomLevel=3:this._currentZoomLevel=4},d.prototype._createTileUrl=function(e,t,i){return this._tileServerUrl+"?pano_id="+this._photo.getPanoId()+"&z="+e.toFixed(0)+"&x="+t.toFixed(0)+"&y="+i.toFixed(0)},d.prototype.toDataURL=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];return this._initialized?this._renderer.domElement.toDataURL(e,t):""},d.prototype.toBlob=function(e){var t,i=[];for(t=1;t<arguments.length;t++)i[t-1]=arguments[t];if(this._initialized){var o=this._renderer.domElement.toDataURL(e,i),n="";n=o.split(",")[0].indexOf("base64")>=0?atob(o.split(",")[1]):decodeURI(o.split(",")[1]);var r=o.split(",")[0].split(":")[1].split(";")[0],a=new Uint8Array(n.length);for(t=0;t<n.length;t++)a[t]=n.charCodeAt(t);return new Blob([a],{type:r})}return null},d.prototype.mouseToPixel=function(e,t){var o,n,r,a=new i;if(this._initialized){this._mouse.x=e/this._renderer.domElement.clientWidth*2-1,this._mouse.y=-t/this._renderer.domElement.clientHeight*2+1,this._raycaster.setFromCamera(this._mouse,this._camera);var s=this._raycaster.intersectObjects(this._scene.children);if(s.length>0){for(n=0,r=s[0].distance,o=1;o<s.length;++o)s[o].distance<r&&(n=o,r=s[o].distance);var h=Math.atan2(s[n].point.z,s[n].point.x),d=Math.acos(s[n].point.y/r);(h=THREE.Math.radToDeg(h))<0&&(h+=360),d=180-(d=THREE.Math.radToDeg(d)),d-=90,h-=180,a.x=(h+180)/360*8192,a.y=4096-(d+90)/180*4096}}return a},d.prototype.mouseToSphere=function(e,t){var i,n,r,a=new o;if(this._initialized){this._mouse.x=e/this._renderer.domElement.clientWidth*2-1,this._mouse.y=-t/this._renderer.domElement.clientHeight*2+1,this._raycaster.setFromCamera(this._mouse,this._camera);var s=this._raycaster.intersectObjects(this._scene.children);if(s.length>0){for(n=0,r=s[0].distance,i=1;i<s.length;++i)s[i].distance<r&&(n=i,r=s[i].distance);var h=Math.atan2(s[n].point.z,s[n].point.x),d=Math.acos(s[n].point.y/r);(h=THREE.Math.radToDeg(h))<0&&(h+=360),d=180-(d=THREE.Math.radToDeg(d)),d-=90,h-=180,a.setPhi(d),a.setTheta(h),a.setRadius(r)}}return a},d.prototype.update=function(){this._phi=THREE.Math.degToRad(90-this._pov.getPitch()),this._theta=THREE.Math.degToRad(this._pov.getHeading()+180),this._target.x=_*Math.sin(this._phi)*Math.cos(this._theta),this._target.y=_*Math.cos(this._phi),this._target.z=_*Math.sin(this._phi)*Math.sin(this._theta),this._camera.lookAt(this._target),this._row=THREE.Math.degToRad(this._pov.getRow()),this._camera.rotateZ(this._row),this._renderer.render(this._scene,this._camera)},d.prototype.render=function(){var e=this;requestAnimationFrame(function(){return e.render()}),this.update()},p.prototype.constructor=p,p.prototype.getPov=function(){return this._panoViewer.getPov()},p.prototype.setPov=function(e){this._panoViewer.setPov(e)},p.prototype.getCurrentPano=function(){return this._currentPanoId},p.prototype.getCurrentZoomLevel=function(){return this._panoViewer.getCurrentZoomLevel()},p.prototype.hasPanorama=function(){return""!==this._currentPanoId},p.prototype.getPanoramaByLocation=function(e,t,i){var o=this;this._isSearchingPanorama||(this._isSearchingPanorama=!0,this._panoProvider.searchPanorama(e,function(n){void 0===n?(i&&i("Photo not found."),o._isSearchingPanorama=!1):o._panoProvider.getPanoramaLinks(n,function(i){o._currentPanoId=n.getPanoId(),o._panoViewer.getPov().setHeading(n.headingTo(e)),o._panoViewer.loadPanorama(n,i),t&&t(n),o._onPanoLinkLoadedFunction&&o._onPanoLinkLoadedFunction(n),o._isSearchingPanorama=!1},function(e){i&&i(e),o._isSearchingPanorama=!1})},function(e){i&&i(e),o._isSearchingPanorama=!1}))},p.prototype.goToNextPhotoInSession=function(e,t){var i=this;this._isSearchingPanorama||""!==this._currentPanoId&&(this._isSearchingPanorama=!0,this._panoProvider.searchNextPanorama(this._currentPanoId,function(o){void 0===o?(t&&t("Photo not found."),i._isSearchingPanorama=!1):i._panoProvider.getPanoramaLinks(o,function(t){i._currentPanoId=o.getPanoId(),i._panoViewer.loadPanorama(o,t),e&&e(o),i._onPanoLinkLoadedFunction&&i._onPanoLinkLoadedFunction(o),i._isSearchingPanorama=!1},function(e){t&&t(e),i._isSearchingPanorama=!1})},function(e){t&&t(e),i._isSearchingPanorama=!1}))},p.prototype.goToPreviousPhotoInSession=function(e,t){var i=this;this._isSearchingPanorama||""!==this._currentPanoId&&(this._isSearchingPanorama=!0,this._panoProvider.searchPreviousPanorama(this._currentPanoId,function(o){void 0===o?(t&&t("Photo not found."),i._isSearchingPanorama=!1):i._panoProvider.getPanoramaLinks(o,function(t){i._currentPanoId=o.getPanoId(),i._panoViewer.loadPanorama(o,t),e&&e(o),i._onPanoLinkLoadedFunction&&i._onPanoLinkLoadedFunction(o),i._isSearchingPanorama=!1},function(e){t&&t(e),i._isSearchingPanorama=!1})},function(e){t&&t(e),i._isSearchingPanorama=!1}))},p.prototype.toDataURL=function(e){var t,i=[];for(t=1;t<arguments.length;t++)i[t-1]=arguments[t];return this._panoViewer.update(),this._panoViewer.toDataURL(e,i)},p.prototype.toBlob=function(e){var t,i=[];for(t=1;t<arguments.length;t++)i[t-1]=arguments[t];return this._panoViewer.update(),this._panoViewer.toBlob(e,i)},p.prototype.calculateHeading=function(e,t){return console.warn("LandViewPanorama.calculateHeading is being deprecated. Use LandViewPhoto.headingTo instead."),t.headingTo(e)},p.prototype.mouseToPixel=function(e,t){return this._panoViewer.mouseToPixel(e,t)},p.prototype.mouseToSphere=function(e,t){return this._panoViewer.mouseToSphere(e,t)},p.prototype._onLinkClicked=function(e,t){var o=this;this._isSearchingPanorama=!0,this._panoProvider.getPanoramaInfo(e.getPanoId(),function(e){void 0===e?o._isSearchingPanorama=!1:o._panoProvider.getPanoramaLinks(e,function(r){var a=n.geographicToWebMercator(t.getPosition()),s=n.geographicToWebMercator(e.getPosition()),h=s.x-a.x,d=s.y-a.y,p=new i(a.x+2*h,a.y+2*d),u=e.headingTo(n.webMercatorToGeographic(p));o._currentPanoId=e.getPanoId(),o._panoViewer.getPov().setHeading(u),o._panoViewer.loadPanorama(e,r),o._onPanoLinkLoadedFunction&&o._onPanoLinkLoadedFunction(e),o._isSearchingPanorama=!1},function(e){o._isSearchingPanorama=!1})},function(e){o._isSearchingPanorama=!1})},u.prototype.constructor=u,u.prototype.searchPanorama=function(e,t,o){var a=n.geographicToWebMercator(e),s=new i(a.x-this._searchRadiusMeters,a.y-this._searchRadiusMeters),h=new i(a.x+this._searchRadiusMeters,a.y+this._searchRadiusMeters),d=this._searchRadiusMeters*this._searchRadiusMeters,p=this._url+"query?geometryType=esriGeometryEnvelope&geometry="+s.toString()+","+h.toString()+"&outFields=pano_id,angle&inSR=3857&spatialRel=esriSpatialRelIntersects&outSR=3857&f=json";if(this._addDirtyWhere){var u=(new Date).getTime().toFixed(0);p=p+"&where="+(u=u+"%3D"+u)}$.getJSON(p).done(function(e){if(void 0!==e.features&&void 0!==e.geometryType&&void 0!==e.fields)if(2!==e.fields.length&&void 0!==o&&o("Invalid geometry response."),0!==e.features.length)if(1===e.features.length)(c=new r).setPanoId(e.features[0].attributes.pano_id?e.features[0].attributes.pano_id:e.features[0].attributes.PANO_ID),c.setAngle(e.features[0].attributes.angle?e.features[0].attributes.angle:e.features[0].attributes.ANGLE),c.setPosition(n.webMercatorToGeographic(new i(e.features[0].geometry.x,e.features[0].geometry.y))),t(c);else{for(var s=-1,h=Number.MAX_VALUE,p=0;p<e.features.length;++p){var u=i.distanceSquared(a,new i(e.features[p].geometry.x,e.features[p].geometry.y));u<d&&u<h&&(h=u,s=p)}if(-1==s)t(void 0);else{var c=new r;c.setPanoId(e.features[s].attributes.pano_id?e.features[s].attributes.pano_id:e.features[s].attributes.PANO_ID),c.setAngle(e.features[s].attributes.angle?e.features[s].attributes.angle:e.features[s].attributes.ANGLE),c.setPosition(n.webMercatorToGeographic(new i(e.features[s].geometry.x,e.features[s].geometry.y))),t(c)}}else t(void 0);else void 0!==o&&o("Invalid geometry response.")}).fail(function(e,t,i){void 0!==o&&o(e.responseText)})},u.prototype.searchNextPanorama=function(e,t,o){for(var a=e.substr(0,22),s=parseInt(e.substr(22)),h=(++s).toFixed();8!=h.length;)h="0"+h;var d=a+h,p=this._url+"query?where=pano_id+=+%27"+d+"%27";if(p+="&outFields=pano_id,angle&outSR=3857&f=json",this._addDirtyWhere){var u=(new Date).getTime().toFixed(0);p=p+"&"+(u=u+"%3D"+u)}$.getJSON(p).done(function(e){if(void 0!==e.features&&void 0!==e.geometryType&&void 0!==e.fields)if(2===e.fields.length)if(0!==e.features.length){var a=new r;a.setPanoId(e.features[0].attributes.pano_id?e.features[0].attributes.pano_id:e.features[0].attributes.PANO_ID),a.setAngle(e.features[0].attributes.angle?e.features[0].attributes.angle:e.features[0].attributes.ANGLE),a.setPosition(n.webMercatorToGeographic(new i(e.features[0].geometry.x,e.features[0].geometry.y))),t(a)}else t(void 0);else void 0!==o&&o("Invalid geometry response.");else void 0!==o&&o("Invalid geometry response.")}).fail(function(e,t,i){void 0!==o&&o(e.responseText)})},u.prototype.searchPreviousPanorama=function(e,t,o){var a=e.substr(0,22),s=parseInt(e.substr(22));if(--s<1)t(void 0);else{for(var h=s.toFixed();8!=h.length;)h="0"+h;var d=a+h,p=this._url+"query?where=pano_id+=+%27"+d+"%27";if(p+="&outFields=pano_id,angle&outSR=3857&f=json",this._addDirtyWhere){var u=(new Date).getTime().toFixed(0);p=p+"&"+(u=u+"%3D"+u)}$.getJSON(p).done(function(e){if(void 0!==e.features&&void 0!==e.geometryType&&void 0!==e.fields)if(2===e.fields.length)if(0!==e.features.length){var a=e.features[e.features.length-1],s=new r;s.setPanoId(a.attributes.pano_id?a.attributes.pano_id:a.attributes.PANO_ID),s.setAngle(a.attributes.angle?a.attributes.angle:a.attributes.ANGLE),s.setPosition(n.webMercatorToGeographic(new i(a.geometry.x,a.geometry.y))),t(s)}else t(void 0);else void 0!==o&&o("Invalid geometry response.");else void 0!==o&&o("Invalid geometry response.")}).fail(function(e,t,i){void 0!==o&&o(e.responseText)})}},u.prototype.getPanoramaInfo=function(e,t,o){var a=this._url+"query?where=pano_id+=+%27"+e+"%27";if(a+="&outFields=pano_id,angle&outSR=3857&f=json",this._addDirtyWhere){var s=(new Date).getTime().toFixed(0);a=a+"&"+(s=s+"%3D"+s)}$.getJSON(a).done(function(e){if(void 0!==e.features&&void 0!==e.geometryType&&void 0!==e.fields)if(2===e.fields.length)if(0!==e.features.length){var a=e.features[e.features.length-1],s=new r;s.setPanoId(a.attributes.pano_id?a.attributes.pano_id:a.attributes.PANO_ID),s.setAngle(a.attributes.angle?a.attributes.angle:a.attributes.ANGLE),s.setPosition(n.webMercatorToGeographic(new i(a.geometry.x,a.geometry.y))),t(s)}else void 0!==o&&o(void 0);else void 0!==o&&o("Invalid geometry response.");else void 0!==o&&o("Invalid geometry response.")}).fail(function(e,t,i){void 0!==o&&o(e.responseText)})},u.prototype.getPanoramaLinks=function(e,t,o){var r=e.getPanoId(),s=n.geographicToWebMercator(e.getPosition()),h=new i(s.x-_,s.y-_),d=new i(s.x+_,s.y+_),p=[],u=this._url+"query?geometryType=esriGeometryEnvelope&geometry="+h.toString()+","+d.toString()+"&outFields=pano_id&inSR=3857&spatialRel=esriSpatialRelIntersects&outSR=3857&f=json";if(this._addDirtyWhere){var c=(new Date).getTime().toFixed(0);u=u+"&where="+(c=c+"%3D"+c)}$.getJSON(u).done(function(h){if(void 0!==h.features&&void 0!==h.geometryType&&void 0!==h.fields)if(1===h.fields.length){for(var d=0;d<h.features.length;++d){var u=h.features[d].attributes.pano_id?h.features[d].attributes.pano_id:h.features[d].attributes.PANO_ID;if(u!==r){var c=new i(h.features[d].geometry.x,h.features[d].geometry.y),_=i.distanceSquared(s,c);if(_<400){var l=new a;l.setPanoId(u),l.setHeading(e.headingTo(n.webMercatorToGeographic(c))),l.setDistanceMeters(Math.sqrt(_)),p.push(l)}}}t(p)}else void 0!==o&&o("Invalid geometry response.");else void 0!==o&&o("Invalid geometry response.")}).fail(function(e,t,i){void 0!==o&&o(e.responseText)})},c.prototype.constructor=c,c.prototype.searchPanorama=function(e,t,o){var a=this,s=n.geographicToWebMercator(e),h=new i(s.x-a._searchRadiusMeters,s.y-a._searchRadiusMeters),d=new i(s.x+a._searchRadiusMeters,s.y+a._searchRadiusMeters),p=a._searchRadiusMeters*a._searchRadiusMeters,u=a._url+"SERVICE=WFS&REQUEST=GetFeature&VERSION=1.1.0&SRSNAME=EPSG:3857&EXCEPTIONS=application/json";u=(u=u+"&TYPENAME="+a._typeName)+"&BBOX="+h.toString()+","+d.toString()+",EPSG:3857","GEOSERVER"===this._serverType?u+="&PROPERTYNAME=the_geom,pano_id,angle":u+="&PROPERTYNAME=pano_id,angle",a._useJSONP?u+="&FORMAT_OPTIONS=callback:parseResponse&OUTPUTFORMAT=text/javascript":u=u+"&OUTPUTFORMAT="+this._geojsonOutputFormat,$.ajax({jsonp:!1,jsonpCallback:"parseResponse",type:"GET",url:u,dataType:a._useJSONP?"jsonp":"json",success:function(e){if(void 0!==e.features&&void 0!==e.type)if(0!==e.features.length)if(void 0!==e.features[0].properties.pano_id&&void 0!==e.features[0].properties.angle&&void 0!==e.features[0].geometry)if(1===e.features.length)(c=new r).setPanoId(e.features[0].properties.pano_id),c.setAngle(e.features[0].properties.angle),c.setPosition(n.webMercatorToGeographic(new i(e.features[0].geometry.coordinates[0],e.features[0].geometry.coordinates[1]))),t(c);else{for(var a=-1,h=Number.MAX_VALUE,d=0;d<e.features.length;++d){var u=i.distanceSquared(s,new i(e.features[d].geometry.coordinates[0],e.features[d].geometry.coordinates[1]));u<p&&u<h&&(h=u,a=d)}if(-1==a)t(void 0);else{var c=new r;c.setPanoId(e.features[a].properties.pano_id),c.setAngle(e.features[a].properties.angle),c.setPosition(n.webMercatorToGeographic(new i(e.features[a].geometry.coordinates[0],e.features[a].geometry.coordinates[1]))),t(c)}}else void 0!==o&&o("Invalid geometry response.");else t(void 0);else void 0!==o&&o("Invalid geometry response.")},error:function(e,t,i){void 0!==o&&o(void 0!==i.message?i.message:"Invalid request.")}})},c.prototype.searchNextPanorama=function(e,t,o){for(var a=this,s=e.substr(0,22),h=parseInt(e.substr(22)),d=(++h).toFixed();8!=d.length;)d="0"+d;var p=s+d,u=a._url+"SERVICE=WFS&REQUEST=GetFeature&VERSION=1.1.0&SRSNAME=EPSG:3857&EXCEPTIONS=application/json&MAXFEATURES=1";u=u+"&TYPENAME="+a._typeName,u="MAPSERVER"===this._serverType?u+"&Filter=<Filter><PropertyIsEqualTo><PropertyName>pano_id</PropertyName><Literal>"+p+"</Literal></PropertyIsEqualTo></Filter>":u+"&CQL_FILTER=pano_id+=+%27"+p+"%27","GEOSERVER"===this._serverType?u+="&PROPERTYNAME=the_geom,pano_id,angle":u+="&PROPERTYNAME=pano_id,angle",a._useJSONP?u+="&FORMAT_OPTIONS=callback:parseResponse&OUTPUTFORMAT=text/javascript":u=u+"&OUTPUTFORMAT="+this._geojsonOutputFormat,$.ajax({jsonp:!1,jsonpCallback:"parseResponse",type:"GET",url:u,dataType:a._useJSONP?"jsonp":"json",success:function(e){if(void 0!==e.features&&void 0!==e.type)if(0!==e.features.length)if(void 0!==e.features[0].properties.pano_id&&void 0!==e.features[0].properties.angle&&void 0!==e.features[0].geometry){var a=new r;a.setPanoId(e.features[0].properties.pano_id),a.setAngle(e.features[0].properties.angle),a.setPosition(n.webMercatorToGeographic(new i(e.features[0].geometry.coordinates[0],e.features[0].geometry.coordinates[1]))),t(a)}else void 0!==o&&o("Invalid geometry response.");else t(void 0);else void 0!==o&&o("Invalid geometry response.")},error:function(e,t,i){void 0!==o&&o(void 0!==i.message?i.message:"Invalid request.")}})},c.prototype.searchPreviousPanorama=function(e,t,o){var a=this,s=e.substr(0,22),h=parseInt(e.substr(22));if(--h<1)t(void 0);else{for(var d=h.toFixed();8!=d.length;)d="0"+d;var p=s+d,u=a._url+"SERVICE=WFS&REQUEST=GetFeature&VERSION=1.1.0&SRSNAME=EPSG:3857&EXCEPTIONS=application/json&MAXFEATURES=1";u=u+"&TYPENAME="+a._typeName,u="MAPSERVER"===this._serverType?u+"&Filter=<Filter><PropertyIsEqualTo><PropertyName>pano_id</PropertyName><Literal>"+p+"</Literal></PropertyIsEqualTo></Filter>":u+"&CQL_FILTER=pano_id+=+%27"+p+"%27","GEOSERVER"===this._serverType?u+="&PROPERTYNAME=the_geom,pano_id,angle":u+="&PROPERTYNAME=pano_id,angle",a._useJSONP?u+="&FORMAT_OPTIONS=callback:parseResponse&OUTPUTFORMAT=text/javascript":u=u+"&OUTPUTFORMAT="+this._geojsonOutputFormat,$.ajax({jsonp:!1,jsonpCallback:"parseResponse",type:"GET",url:u,dataType:a._useJSONP?"jsonp":"json",success:function(e){if(void 0!==e.features&&void 0!==e.type)if(0!==e.features.length)if(void 0!==e.features[0].properties.pano_id&&void 0!==e.features[0].properties.angle&&void 0!==e.features[0].geometry){var a=new r;a.setPanoId(e.features[0].properties.pano_id),a.setAngle(e.features[0].properties.angle),a.setPosition(n.webMercatorToGeographic(new i(e.features[0].geometry.coordinates[0],e.features[0].geometry.coordinates[1]))),t(a)}else void 0!==o&&o("Invalid geometry response.");else t(void 0);else void 0!==o&&o("Invalid geometry response.")},error:function(e,t,i){void 0!==o&&o(void 0!==i.message?i.message:"Invalid request.")}})}},c.prototype.getPanoramaInfo=function(e,t,o){var a=this,s=a._url+"SERVICE=WFS&REQUEST=GetFeature&VERSION=1.1.0&SRSNAME=EPSG:3857&EXCEPTIONS=application/json&MAXFEATURES=1";s=s+"&TYPENAME="+a._typeName,s="MAPSERVER"===this._serverType?s+"&Filter=<Filter><PropertyIsEqualTo><PropertyName>pano_id</PropertyName><Literal>"+e+"</Literal></PropertyIsEqualTo></Filter>":s+"&CQL_FILTER=pano_id+=+%27"+e+"%27","GEOSERVER"===this._serverType?s+="&PROPERTYNAME=the_geom,pano_id,angle":s+="&PROPERTYNAME=pano_id,angle",a._useJSONP?s+="&FORMAT_OPTIONS=callback:parseResponse&OUTPUTFORMAT=text/javascript":s=s+"&OUTPUTFORMAT="+this._geojsonOutputFormat,$.ajax({jsonp:!1,jsonpCallback:"parseResponse",type:"GET",url:s,dataType:a._useJSONP?"jsonp":"json",success:function(e){if(void 0!==e.features&&void 0!==e.type)if(0!==e.features.length)if(void 0!==e.features[0].properties.pano_id&&void 0!==e.features[0].properties.angle&&void 0!==e.features[0].geometry){var a=new r;a.setPanoId(e.features[0].properties.pano_id),a.setAngle(e.features[0].properties.angle),a.setPosition(n.webMercatorToGeographic(new i(e.features[0].geometry.coordinates[0],e.features[0].geometry.coordinates[1]))),t(a)}else void 0!==o&&o("Invalid geometry response.");else onSearchPanoramaEnd(void 0);else void 0!==o&&o("Invalid geometry response.")},error:function(e,t,i){void 0!==o&&o(void 0!==i.message?i.message:"Invalid request.")}})},c.prototype.getPanoramaLinks=function(e,t,o){var r=this,s=e.getPanoId(),h=n.geographicToWebMercator(e.getPosition()),d=new i(h.x-_,h.y-_),p=new i(h.x+_,h.y+_),u=[],c=r._url+"SERVICE=WFS&REQUEST=GetFeature&VERSION=1.1.0&SRSNAME=EPSG:3857&EXCEPTIONS=application/json";c=(c=c+"&TYPENAME="+r._typeName)+"&BBOX="+d.toString()+","+p.toString()+",EPSG:3857","GEOSERVER"===this._serverType?c+="&PROPERTYNAME=the_geom,pano_id":c+="&PROPERTYNAME=pano_id",r._useJSONP?c+="&FORMAT_OPTIONS=callback:parseResponse&OUTPUTFORMAT=text/javascript":c=c+"&OUTPUTFORMAT="+this._geojsonOutputFormat,$.ajax({jsonp:!1,jsonpCallback:"parseResponse",type:"GET",url:c,dataType:r._useJSONP?"jsonp":"json",success:function(r){if(void 0!==r.features&&void 0!==r.type)if(0!==r.features.length)if(void 0!==r.features[0].properties.pano_id&&void 0!==r.features[0].geometry){for(var d=0;d<r.features.length;++d){var p=r.features[d].properties.pano_id;if(p!==s){var c=new i(r.features[d].geometry.coordinates[0],r.features[d].geometry.coordinates[1]),_=i.distanceSquared(h,c);if(_<400){var l=new a;l.setPanoId(p),l.setHeading(e.headingTo(n.webMercatorToGeographic(c))),l.setDistanceMeters(Math.sqrt(_)),u.push(l)}}}t(u)}else void 0!==o&&o("Invalid geometry response.");else t(u);else void 0!==o&&o("Invalid geometry response.")},error:function(e,t,i){void 0!==o&&o(void 0!==i.message?i.message:"Invalid request.")}})},e.LandViewLatLng=t,e.LandViewXY=i,e.LandViewSphereCoord=o,e.LandViewPhoto=r,e.LandViewPhotoLink=a,e.LandViewPov=s,e.LandViewPovChangedEventArgs=h,e.LandViewPanorama=p,e.LandViewPanoramaViewer=d,e.LandViewWebMercatorUtils=n,e.LandViewPanoramaArcGISServerProvider=u,e.LandViewPanoramaWFSProvider=c,e.LadybugSphereRadius=_,e.LadybugSphereRadiusSquared=400,e.PanoramaDefaultWidth=8192,e.PanoramaDefaultHeight=4096,e.LinkSearchAngleRange=15,Object.defineProperty(e,"__esModule",{value:!0})});
